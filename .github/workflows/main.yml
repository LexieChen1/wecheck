deploy:
  needs: build
  runs-on: ubuntu-latest

  steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: Set up SSH key
    run: |
      echo "${{ secrets.EC2 }}" > key.pem
      chmod 600 key.pem

  - name: Deploy to EC2
    run: |
      scp -o StrictHostKeyChecking=no -i key.pem ./backend/.env ${{ secrets.EC2USER }}@${{ secrets.EC2HOST }}:/home/${{ secrets.EC2USER }}/wecheck/.env || echo "Skipping .env upload"

      ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2USER }}@${{ secrets.EC2HOST }} << 'EOF'
        if [ ! -d "wecheck" ]; then
          git clone https://github.com/LexieChen1/wecheck.git
        fi
        cd wecheck
        git pull origin main
        docker compose down
        docker compose up -d --build
EOF
